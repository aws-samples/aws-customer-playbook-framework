# Amazon Bedrock セキュリティイベントに対応するためのセキュリティプレイブック
このドキュメントは情報提供のみを目的としています。 本書の発行日現在のAmazon ウェブサービス (AWS) が提供している製品および慣行を表しており、予告なしに変更されることがあります。 お客様は、本書に記載された情報および AWS の製品またはサービスの使用について、お客様自身で評価する責任を負うものとします。これらの評価は、明示的か黙示的かを問わず、いかなる種類の保証もなく「現状のまま」提供されます。 この文書は、AWS、その関連会社、サプライヤー、またはライセンサーからの保証、表明、契約上のコミットメント、条件、または保証をするものではありません。 お客様に対する AWS の責任と責任は AWS 契約によって管理されており、この文書は AWS と顧客間の契約の一部ではなく、また変更されるものでもありません。

© 2024 Amazon ウェブサービス株式会社またはその関連会社。 全著作権所有。 この作品はクリエイティブ・コモンズ表示 4.0 国際ライセンスの下に提供されています。

本 AWS コンテンツは、http://aws.amazon.com/agreement で入手可能な AWS カスタマー契約の条件、またはお客様とアマゾンウェブサービス株式会社、Amazon ウェブサービス、EMEA、SARL、あるいはその両方との間のその他の書面による契約に従って提供されます。

## 連絡窓口

作成者:`著者名`\
承認者:`承認者名`\
最終承認日:

## エグゼクティブサマリー

お客様への継続的な取り組みの一環として、AWS はこれを提供しています
セキュリティインシデント対応プレイブックには、以下に必要な手順が説明されています。
Amazon Bedrock が AWS アカウント内の不正使用のソースまたはターゲットとなっているセキュリティイベントを調査します。 このドキュメントの目的は、セキュリティイベントが発生した疑いがある場合に取るべきアクションに関する規範的なガイダンスを提供することです。

! [画像] (/images/nist_life_cycle.png)

*AWS インシデント対応の側面*

## 準備

インシデント対応活動を迅速かつ効果的に実行するためには、組織内の人材、プロセス、テクノロジーを準備することが不可欠です。 [*AWS セキュリティインシデント対応ガイド*] (https://docs.aws.amazon.com/whitepapers/latest/aws-security-incident-response-guide/preparation.html) を確認し、3 つのドメインすべての準備が整っていることを確認するために必要な手順を実装してください。

## AWS サポートに支援を依頼する方法

AWS アカウントまたは組織内の認証情報の漏洩が疑われる場合は、すぐに AWS に通知することが重要です。 AWS サポートを利用する手順は次のとおりです。

### AWS サポートケースを開く

-AWS アカウントにログインします。
-セキュリティイベントの影響を受けた最初のAWS アカウントで、AWS アカウントの所有権を検証しました。
-注:アカウントにアクセスできない場合は、[このフォーム] (https://support.aws.amazon.com/#/contacts/aws-account-support/) を使用してサポートリクエストを送信してください。
-「*サービス*」、「*サポートセンター*」、「*ケースの作成*」を選択します。
-課題タイプ「*アカウントと請求」* を選択します。
-影響を受けるサービスとカテゴリを選択:
-例:
-サービス:アカウント
-カテゴリ:セキュリティ
-重要度を選択:
-エンタープライズサポートまたは導入を検討中のお客様:*ビジネスリスクに関する重大な質問*。
-ビジネスサポートのお客様:*ビジネスリスクに関する緊急の質問*。
-質問や問題を説明してください:
-発生しているセキュリティ問題、影響を受けるリソース、ビジネスへの影響について詳細に説明してください。
-セキュリティイベントが最初に認識された時刻。
-現時点までのイベントタイムラインの要約。
-収集したアーティファクト (スクリーンショット、ログファイル)。
-セキュリティ侵害の疑いがある IAM ユーザーまたはロールの ARN。
-影響を受けるリソースとビジネスへの影響の説明。
-組織内の関与のレベル (例:「このセキュリティイベントは CEO と取締役会が注目している」)。
-オプション:ケース連絡先を追加します。
-「*お問い合わせ*」を選択します。
-希望する連絡言語 (空き状況により異なる場合があります)
-優先連絡方法:ウェブ、電話、チャット (推奨)
-オプション:その他のケース連絡先
-* [送信] をクリック*

-**エスカレーション**: 必要なリソースを投入し、必要に応じてエスカレーションできるように、できるだけ早く AWS アカウントチームに連絡してください。

**注:** 各 AWS アカウントに「代替セキュリティ連絡先」が定義されていることを確認することは非常に重要です。 詳細については、[これ] を参照してください。
記事] (https://aws.amazon.com/blogs/security/update-the-alternate-security-contact-across-your-aws-accounts-for-timely-security-notifications/)。


## Amazon 岩盤

Amazon Bedrock は複数のコンポーネント/サービスで危険にさらされています。

* モデル-主要な AI スタートアップの基盤モデルでも、カスタムモデルでもかまいません。
* 推論-モデルに提供された入力から出力を生成するプロセス
* ナレッジベース-データソースを情報のリポジトリにまとめることができます。
* エージェント-組織データとユーザー入力に基づいてエンドユーザーがアクションを実行できるようにします

AWS アカウントのユーザー（許可されているか許可されていないかを問わず）がBedrockにアクセスする場合、最終的にはモデル、ナレッジベース、またはエージェントのいずれかを通じてアクセスします。 以前に設定されていれば、すべてのプロンプトとその応答はモデル呼び出しログ (https://docs.aws.amazon.com/bedrock/latest/userguide/model-invocation-logging.html) に記録されます。 追加情報については、こちらの Amazon Bedrock のユーザーガイドをご覧ください。https://docs.aws.amazon.com/bedrock/

下の画像は、プロンプト、[エージェント] (https://docs.aws.amazon.com/bedrock/latest/userguide/agents-how.html)、ナレッジベースの関係を表しており、データフローを視覚化する良い方法です ([User Guide] (https://docs.aws.amazon.com/bedrock/latest/userguide/what-is-bedrock.html) から引用)。

! [ビルド時の API 操作中のエージェント構築] (/images/bedrock-01.png)


## 検出

### 注意事項と考慮事項

* ベッドロックはすべての地域 (2024-06-04) ではご利用いただけません。 現在のリージョンの空き状況については、[リンク] (https://docs.aws.amazon.com/bedrock/latest/userguide/bedrock-regions.html) を参照してください。
* モデルに送信されたプロンプトと応答を表示するには、モデル呼び出しログが必要です。 これは地域レベルの設定であり、デフォルトではありません。
* CloudTrail の場合、イベントソース = bedrock.amazonaws.com
* ***InvokeModel*** API は**読み取り専用**のイベントです

### イベント名

以下の表にリストされているイベント名は、Bedrockに関係するセキュリティイベントの調査中にCloudTrailで一般的に見られるイベントの種類のクイックリファレンスです。 表にリストされているイベントのうち、通常のモデル使用時に記録される最も一般的なイベント名は次のとおりです。

* `getFoundationModelAvailability`
* `モデルを呼び出す `
* `レスポンスストリームでモデルを呼び出す `

| **イベント名** | **読み取り専用** | **説明** |
|:-----------------|:-----------------|:--------------------------------|
| ***モデルに関連するイベント*** |---|---|
| `getFoundationModelAvailability` | TRUE | 基礎モデルの可用性を取得 |
| `getUseCaseForModelAccess` | TRUE | 指定されたモデルのユースケースを取得する |
| `InvokeModel` | TRUE | 指定されたBedrockモデルを呼び出し、リクエストボディで提供された入力を使用して推論を実行します |
| `invokeModelWithResponseStream` | TRUE | 指定された Bedrock モデルを呼び出し、チャンキングを使用してリクエストボディに入力された入力を使用して推論を実行します。|
| `ListCustomModels` | TRUE | 作成された Bedrock カスタムモデルを一覧表示する |
| `ListFoundationModels` | TRUE | 使用できるファンデーションモデルを一覧表示 |
| `ListProvisionedModelThouts` | TRUE | モデルにプロビジョニングされたキャパシティを一覧表示 |
|---|---|---|
| ***モデル呼び出しロギングに関連するイベント*** |---|---|
| ``ModelInvocationLoggingConfigurationDelete` | FALSE | 既存の呼び出しログ設定を削除する |
| `getModelInvocationLoggingConfiguration` | TRUE | 既存の呼び出しログ設定を取得 |
| `PutModelInvocationLoggingConfiguration` | FALSE | 既存の呼び出しログ設定を作成します |
|---|---|---|
| ***ナレッジベースに関連するイベント*** |---|---|
| `AssociateAgentKnowledgeBase` | FALSE | このアクションは、エージェントの作成中またはエージェントが作成された後にナレッジベースの関連付けを記録します |
| `CreateDataSource` | FALSE | データソースを作成します |
| `CreateKnowledgeBase` | FALSE | ナレッジベースを作成します |
| `ナレッジベースを削除` | FALSE | ナレッジベースを削除する |
| `getDataSource` | TRUE | データソースに関する情報を取得する |
| `GetKnowledgeBase` | TRUE | 既存のナレッジベースを取得 |
| `ListDataSources` | TRUE | 使用可能なデータソースを一覧表示 |
| `ListKnowledgeBases` | TRUE | 既存のナレッジベースを一覧表示 |
|---|---|---|
| ***エージェントに関連するイベント*** |---|---|
| `CreateAgent` | FALSE | 新しいエージェントとドラフトエージェントバージョンを指すテストエージェントエイリアスを作成します |
| `CreateAgentActionGroup` | FALSE | エージェントのアクショングループを作成します。 アクショングループは、エージェントが呼び出せる API とそれを呼び出すロジックを定義することで、エージェントが顧客のために実行できるアクションを表します。|
| `CreateAgentAlias` | FALSE | エージェントの新しいエイリアスを作成します |
| `DeleteAgent` | FALSE | 以前に作成したエージェントを削除します |
| `GetAgent` | TRUE | 既存のエージェントを取得します |
| `getAgentAlias` | TRUE | 既存のエイリアスを取得する |
| `InvokeAgent` | FALSE | エージェントが処理して応答するように求めるプロンプトを送信します |
| `ListAgentActionGroups` | TRUE | エージェントのアクショングループと各アクショングループに関する情報を一覧表示します |
| `ListAgentAliases` | TRUE | エージェントのエイリアスと各エージェントに関する情報を一覧表示します |
| `ListAgentKnowledgeBases` | TRUE | エージェントに関連するナレッジベースと各ナレッジベースに関する情報を一覧表示する |
| `ListAgents` | TRUE | 既存のエージェントを一覧表示 |
| `ListAgentVersions` | TRUE | エージェントのバージョンと各バージョンに関する情報を一覧表示します |
| `PrepareAgent` | FALSE | 既存の Amazon Bedrock エージェントがランタイムリクエストを受信できるように準備します |
|---|---|---|
| ***ジョブの取り込みに関連するイベント*** |---|---|
| `getIngestionJob` | TRUE | データソースがナレッジベースに追加されるインジェストジョブに関する情報を取得する |
| `listingestionJobs` | TRUE | データソースの取り込みジョブとそれぞれの情報を一覧表示します |
| `startIngeStionJob` | FALSE | 取り込みジョブを開始します。このジョブでは、データソースがナレッジベースに追加されます |
|---|---|---|
| ***RAG に関連するイベント*** |---|---|---|
| `Retrieve` | TRUE | 取り込まれたデータをナレッジベースから取得します (データイベントと見なされ、CloudTrail には表示されません) |
| `RetrieveAndGenerate` | FALSE | ユーザー入力を送信して取得と生成を実行します (データイベントと見なされ、CloudTrail には表示されません) |

### 岩盤の使用方法のスクリーンショット

以下のスクリーンショットは、インシデントレスポンダーが調査中に見つかった出来事を解釈するのに役立つ視覚的な助けになります。 以下の各画像は、記録されたイベント名と一致するアクションを示しています。

---

** ファンデーションモデルの提供状況を確認**
<details>
<summary>スクリーンショットを展開</summary>
-
このイベントは、Amazon Bedrock のメインページを閲覧したときに最初に記録されます。

! [ファンデーションモデルの可用性を取得] (/images/bedrock-02.png)

</details>

---

** 基礎モデルの一覧** と ** カスタムモデルの一覧**
<details>
<summary>スクリーンショットを展開</summary>
-
これらのイベントは、「基本モデル」ページと「カスタムモデル」ページを閲覧すると記録されます。

! [基盤モデルの一覧とカスタムモデルの一覧表示] (/images/bedrock-03.png)

</details>

---

** モデルを呼び出す**
<details>
<summary>スクリーンショットを拡大</summary>
-
このイベントはモデル呼び出し時に記録されます。

! [モデル呼び出しの例] (/images/bedrock-04.png)

モデル呼び出し用の CloudTrail イベントレコードのサンプル:

! [呼び出しモデルのCloudTrail] (/images/bedrock-05.png)

</details>

---

**モデル呼び出し**-その他の例
<details>
<summary>スクリーンショットを拡大</summary>
-
以下の画像は、`InvokeModel` イベント名がどのように記録されるかを示すその他の例を示しています。
最初の図は、モデル呼び出しのさまざまな方法の違いを示しています。
(a) ナレッジベースを使ったモデル呼び出し
(b) モデルの直接呼び出し
(c) Agent を使用したモデル呼び出し

表示される*ユーザー名* は、モデルの起動方法によって異なることに注意してください。

! [エージェントとナレッジベースのモデル呼び出し] (/images/bedrock-06.png)

この違いは、CloudTrail の「InvokeModel」イベントレコードの 2 つのスクリーンショットを並べて表示することで強調されています。
左の画像 = モデルの直接呼び出し
右の画像 = ナレッジベースを使用したモデル呼び出し

! [呼び出しモデルのCloudTrail] (/images/bedrock-07.png)


</details>

---

** モデル呼び出し** または ** レスポンスストリームでモデルを呼び出す**-プロンプトと応答
<details>
<summary>スクリーンショットを展開</summary>
-
「InvokeModel」イベントと「InvokeModelWithResponseStream」イベントは CloudTrail に表示されますが、モデル呼び出しログ (設定されている場合) には各「InvokeModel」イベントに対応するプロンプトとレスポンスも表示されます。 以下の画像は、S3 に送信されたモデル呼び出しログから取得したものです。これらのログには、使用されたプロンプトのほか、モデルからの出力または応答が含まれています (Athena DDL は以下にあります)。

! [S3 モデル呼び出しの例] (/images/bedrock-09.png)

</details>

---

** モデルを呼び出しロギング設定**
<details>
<summary>スクリーンショットを展開</summary>
-
このイベントは、AWS アカウントでモデル呼び出しロギングが設定されている場合に記録されます

! [モデル呼び出しロギングの設定] (/images/bedrock-10.png)

</details>

---

** ナレッジベースの作成**
<details>
<summary>スクリーンショットを展開</summary>
-
ナレッジベースが作成されると、次の CloudTrail イベントレコードが記録されます。 イベントレコードには、リクエストを発行した ID とナレッジベースの名前が含まれます。 ナレッジベースの名前は、`InvokeModel` を使用してモデル呼び出しをキャプチャする後続のログで参照できます。

! [ナレッジベースの作成] (/images/bedrock-11.png)

</details>

---

** エージェントを作成**
<details>
<summary>スクリーンショットを展開</summary>
-
以下の図は、コンソールを使用してエージェントを作成する様子を示しています。 結果としてログに記録されるイベント名は `CreateAgent` です。

! [エージェント作成] (/images/bedrock-12.png)

</details>

---

** 取得** と ** 取得と生成**
<details>
<summary>スクリーンショットを展開</summary>
-
ナレッジベースのテスト時に「Retrieve」と「RetrieveAndGenerate」イベント名がどのように表示されるかを下の画像に示します。 `Retrieve` はナレッジベースからのデータの取得のみをテストし、`RetrieveAndGenerate` はナレッジベースからのデータの取得とレスポンスの生成をテストすることに注意してください。

! [取得、取得、生成] (/images/bedrock-13.png)

</details>

---

### Athena DDL

以下の DDL コードを使用して、Amazon S3 バケットに保存されているモデル呼び出しログから Athena にテーブルを作成します。 コードスニペットの最後にあるバケットの場所に、正しい S3 URI が使用されていることを確認します。

```
外部テーブルの作成 (ブロック_モデル_呼び出し_メタデータ_フィルタなし)
スキーマタイプ文字列、
スキーマバージョン文字列、
タイムスタンプ文字列、
アカウント ID 文字列、
<arn: string>アイデンティティー構造体、
リージョンストリング、
リクエスト ID 文字列、
操作文字列、
モデル ID 文字列、
エラーコード文字列、
入力構造体 < 入力ボディ JSON: 文字列、
入力ボディ S3 パス:文字列、
入力コンテンツタイプ:文字列、
入力トークン数:int>、
出力構造体 < 出力本文 JSON: 文字列、
出力ボディ S3 パス:文字列、
出力コンテンツタイプ:文字列、
出力トークン数:int、
出力イメージのバケットステップサイズ:int、
出力イメージの高さ:int、
出力イメージの幅:int
>
)
行フォーマット SERDE 'org.openx.data.jsonSerde.jsonSerde'
<insert_prefix>ロケーション <insert_S3_bucket>'S3:///'
```

## 対処済みバックログ項目
-インシデント・レスポンダーとして、重要なBedrockイベントをすべて監視できる必要がある
-インシデントレスポンダーとして、Bedrock Cloudtrailのイベントを大規模にクエリするためのプレイブックが必要だ。

## 現在のバックログ項目